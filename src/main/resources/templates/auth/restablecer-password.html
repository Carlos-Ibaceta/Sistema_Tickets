<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Nueva Contraseña - Municipalidad de Cabildo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

  <style>
    :root { --muni-azul: #003366; --muni-dorado: #c5a059; --bg-gris: #f4f6f9; }
    body { background-color: var(--bg-gris); display: flex; align-items: center; justify-content: center; height: 100vh; font-family: 'Segoe UI', sans-serif; }
    .card-custom { background: white; width: 100%; max-width: 420px; padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); border-top: 5px solid var(--muni-azul); }
    .btn-muni { background-color: var(--muni-dorado); color: var(--muni-azul); font-weight: 700; border: none; padding: 12px; transition: all 0.2s; }
    .btn-muni:hover { background-color: #b08d4a; color: white; transform: translateY(-2px); }
    .btn-muni:disabled { background-color: #e9ecef; color: #adb5bd; cursor: not-allowed; transform: none; }
    .logo-img { height: 50px; margin-bottom: 25px; }

    /* REGLAS DE PASSWORD */
    .password-rules { font-size: 0.8rem; color: #6c757d; list-style: none; padding: 0; margin-top: 10px; text-align: left; }
    .password-rules li { margin-bottom: 4px; display: flex; align-items: center; }
    .password-rules li i { width: 15px; margin-right: 5px; }
    .rule-valid { color: #198754; font-weight: 600; }
    .rule-invalid { color: #dc3545; }

    /* ESTE ES EL CSS QUE NO DA ERROR PERO AYUDA EN ALGUNOS NAVEGADORES */
    input[type="password"]::-ms-reveal,
    input[type="password"]::-ms-clear {
      display: none;
    }

    /* TRUCO EXTRA: Si quieres probar esto sin que marque error, usa este comentario especial de IntelliJ: */
    /* noinspection CssInvalidPseudoSelector */
    input[type="password"]::-webkit-password-reveal-button {
      display: none !important;
      -webkit-appearance: none;
    }
  </style>
</head>
<body>

<div class="card-custom">
  <div class="text-center">
    <img th:src="@{/img/logo-cabildo.png}" alt="Logo Cabildo" class="logo-img">
    <h3 class="mb-2 fw-bold" style="color: var(--muni-azul);">Crear Nueva Clave</h3>
    <p class="text-muted small mb-4">Por seguridad, tu nueva contraseña debe cumplir con los siguientes requisitos.</p>
  </div>

  <div th:if="${error}" class="alert alert-danger small"><i class="fas fa-exclamation-triangle me-1"></i> <span th:text="${error}"></span></div>

  <form action="/guardar-nueva-password" method="post" th:if="${token != null}">
    <input type="hidden" name="token" th:value="${token}">

    <div class="mb-3">
      <label class="form-label fw-bold small text-muted">NUEVA CONTRASEÑA</label>
      <div class="input-group">
        <span class="input-group-text bg-light border-end-0"><i class="fas fa-lock text-muted"></i></span>
        <input type="password" id="inputPassword" name="password" class="form-control border-start-0 border-end-0 ps-0" placeholder="Escribe aquí..." required>
        <button class="btn btn-outline-secondary border-start-0 bg-light text-muted" type="button" id="togglePassword">
          <i class="fas fa-eye"></i>
        </button>
      </div>

      <ul class="password-rules mt-3 ps-1">
        <li id="rule-length"><i class="far fa-circle"></i> Mínimo 8 caracteres</li>
        <li id="rule-upper"><i class="far fa-circle"></i> Al menos una mayúscula (A-Z)</li>
        <li id="rule-number"><i class="far fa-circle"></i> Al menos un número (0-9)</li>
        <li id="rule-symbol"><i class="far fa-circle"></i> Un símbolo (@, #, $, %, etc.)</li>
      </ul>
    </div>

    <button type="submit" id="btnSubmit" class="btn btn-muni w-100" disabled>
      <i class="fas fa-save me-2"></i> GUARDAR CAMBIOS
    </button>
  </form>

  <div th:if="${token == null}" class="text-center mt-3">
    <p class="text-danger fw-bold small">Enlace inválido o expirado.</p>
    <a href="/login" class="btn btn-outline-secondary w-100">Volver al Inicio</a>
  </div>
</div>

<script>
  // Script para mostrar/ocultar contraseña
  const togglePassword = document.querySelector('#togglePassword');
  const password = document.querySelector('#inputPassword');
  const icon = togglePassword.querySelector('i');

  togglePassword.addEventListener('click', function (e) {
    const type = password.getAttribute('type') === 'password' ? 'text' : 'password';
    password.setAttribute('type', type);
    icon.classList.toggle('fa-eye');
    icon.classList.toggle('fa-eye-slash');
  });

  // Script de Validación en Tiempo Real
  const input = document.getElementById('inputPassword');
  const btnSubmit = document.getElementById('btnSubmit');

  const ruleLength = document.getElementById('rule-length');
  const ruleUpper = document.getElementById('rule-upper');
  const ruleNumber = document.getElementById('rule-number');
  const ruleSymbol = document.getElementById('rule-symbol');

  input.addEventListener('input', function() {
    const val = input.value;
    let isValid = true;

    if (val.length >= 8) { setValid(ruleLength, true); } else { setValid(ruleLength, false); isValid = false; }
    if (/[A-Z]/.test(val)) { setValid(ruleUpper, true); } else { setValid(ruleUpper, false); isValid = false; }
    if (/[0-9]/.test(val)) { setValid(ruleNumber, true); } else { setValid(ruleNumber, false); isValid = false; }
    if (/[@#$%^&+=!._\-]/.test(val)) { setValid(ruleSymbol, true); } else { setValid(ruleSymbol, false); isValid = false; }

    btnSubmit.disabled = !isValid;
  });

  function setValid(element, valid) {
    const icon = element.querySelector('i');
    if (valid) {
      element.classList.add('rule-valid');
      element.classList.remove('rule-invalid');
      icon.className = 'fas fa-check-circle';
    } else {
      element.classList.remove('rule-valid');
      icon.className = 'far fa-circle';
    }
  }
</script>

</body>
</html>